JS_PREFIX = "js"
JS_SRC_PREFIX="src/js"
ROOT_PREFIX = "dest"
PREFIX = "dest/js"
BROWSERIFY_JS = %w[big-integer flatted]
TS_BASE = %w[fcs-validate web-fc-solve--expand-moves web-fc-solve]
JS_CURATED_SOURCES = %w[solitaire iphone auto-stack-clear auto-turnover autoplay ie-opera-background-fix statistics solver-freecell solver-freecell-worker agnes golf klondike klondike1t flowergarden fortythieves freecell grandclock montecarlo pyramid russian-solitaire scorpion spider spider1s spider2s spiderette tritowers will-o-the-wisp yukon application]
JS = %w[yui-breakout yui-debug require require--debug] + JS_CURATED_SOURCES + TS_BASE + BROWSERIFY_JS
YUI_DIST="yui-unpack/"
YUI_SRC = "ext/yui/yui-all-min.js"
YUI = "#{PREFIX}/yui-all-min.js"
ALL = "#{PREFIX}/all.js"
MINIFIED = "#{PREFIX}/all-min.js"
COMBINED = "#{PREFIX}/combined-min.js"
# COMPRESSOR = "ext/yuicompressor-2.4.2/build/yuicompressor-2.4.2.jar"
COMPRESSOR = "bin/Run-YUI-Compressor"
TEMPLATE = "index.erb"

IMAGES = Dir.glob("{dondorf,layouts}/**/*.png") + Dir.glob("*.{css,gif,png,jpg}") + [".htaccess"]

DEST_INDEX = "dest/index.html"
DEST_INDEX_DEV = "dest/index-dev.html"

def create_index(index, development = false)
  require "erb"

  File.open(index, "w") do |f|
    f.write(ERB.new(File.read(TEMPLATE)).result(binding))
  end
end

DEST_IMAGES = []
IMAGES.each do |img|
    d = "dest/#{img}"
    DEST_IMAGES << d
    file d => img do
        sh "mkdir -p $(dirname #{d})"
        sh "cp -f #{img} #{d}"
    end
end

file YUI => YUI_SRC do
    sh "cp -f #{YUI_SRC} #{YUI}"
end

dest_js_s = []

def js_pat_file(fn)
    src = "#{JS_SRC_PREFIX}/#{fn}"
    return src
end

def js_js_pat_file(fn)
    return js_pat_file(fn + ".js")
end

def js_file(fn)
    src = js_pat_file(fn)
    dest = "#{PREFIX}/#{fn}"
    file dest => src do
        sh "cp -f #{src} #{dest}"
    end
    return dest
end

def js_root_file(fn)
    src = "#{JS_SRC_PREFIX}/#{fn}"
    dest = "#{ROOT_PREFIX}/#{fn}"
    dest2 = "#{PREFIX}/js/#{fn}"
    file dest2 => src do
        sh "cp -f #{src} #{dest2}"
    end
    file dest => src do
        sh "cp -f #{src} #{dest}"
    end
    return dest
end

BROWSERIFY_JS.each do |base|
    dest2 = "#{JS_SRC_PREFIX}/#{base}.js"
    file dest2 do
        sh "browserify -s #{base} -r #{base} -o #{dest2}"
    end
end


TS_BASE.each do |base|
    dest2 = "#{JS_SRC_PREFIX}/#{base}.js"
    src2 = "#{JS_SRC_PREFIX}/#{base}.ts"
    file dest2 => src2 do
        sh "tsc --target es6 --module amd --out #{dest2} #{src2}"
    end
end

src = "ext/#{YUI_DIST}"
dest = "dest/js/#{YUI_DIST}"
file dest => src do
    sh "rsync -a #{src} #{dest}"
    sh "rm -fr #{dest}/yui/{api,docs,releasenotes,tests}"
end
file ALL => dest

JS.each do |fn_base|
    fn = fn_base + ".js"
    dest_js_s << js_file(fn)
end

dest_js_extra = []
dest_js_extra << js_file('libfcs-wrap.d.ts')
dest_js_extra << js_file('libfcs-wrap.js')
dest_js_extra << js_file('libfreecell-solver-asm.js')
dest_js_extra << js_file('libfreecell-solver-asm.js.mem')
dest_js_extra << js_file('libfreecell-solver.js')
dest_js_extra << js_file('libfreecell-solver.js.mem')
dest_js_extra << js_file('libfreecell-solver.min.js')
dest_js_extra << js_root_file('libfreecell-solver.js.mem')
dest_js_extra << js_root_file('libfreecell-solver.wasm')

desc "concatenated solitaire sources"
file ALL => dest_js_s do
  File.open(ALL, "w") do |f|
    JS.each do |fn|
      f.write(File.read("#{JS_SRC_PREFIX}/#{fn}.js"))
    end
  end
end

file ALL => dest_js_extra do
end

desc "minified solitaire sources"
file MINIFIED => ALL do
  # sh "java -jar #{COMPRESSOR} -o #{MINIFIED} #{ALL}"
  sh "#{COMPRESSOR} -o #{MINIFIED} #{ALL}"
end

desc "concatenated minified solitaire and YUI sources"
file COMBINED => [YUI, MINIFIED] do
  sh "cat #{YUI} #{MINIFIED} > #{COMBINED}"
end

desc "development file with separated, unminified source files"
file DEST_INDEX_DEV => TEMPLATE do
  create_index DEST_INDEX_DEV, true
end

desc "production file with separated, unminified source files"
file DEST_INDEX => [TEMPLATE, COMBINED] do
  # create_index DEST_INDEX
  create_index DEST_INDEX, true
end

task :prettier do
    sh "prettier --arrow-parens always --tab-width 4 --trailing-comma all --write " + JS_CURATED_SOURCES.map { |bn| js_js_pat_file(bn) }.join(" ")
end

task :images => DEST_IMAGES

task :clean do
  sh "rm -f #{[ALL, MINIFIED, COMBINED, DEST_INDEX, DEST_INDEX_DEV].join(" ")}"
end

task :upload => :default do
  # sh "rsync --progress --inplace -a -v dest hostgator:public_html/temp-Solitairey-ekrimyk/"
  # sh "rsync --progress --inplace -a -v dest hostgator:public_html/temp-Solitairey-fc-solve-loop-NjU78o/"
  sh "rsync --progress --inplace -a -v dest hostgator:public_html/temp-Solitairey-fc-solve/"
end

task :upload_local => :default do
  # sh "rsync --progress --inplace -a -v dest hostgator:public_html/temp-Solitairey-ekrimyk/"
  sh "rsync --progress --inplace -a -v dest /var/www/html/shlomif/temp-Solitairey/"
end

task :default => [DEST_INDEX, DEST_INDEX_DEV, :images]
